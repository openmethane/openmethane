Refactor to use a common function for running subprocesses.

This improves the logging of subprocesses and allows for easier debugging of issues.