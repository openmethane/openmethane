# cmaq_preprocess

The CMAQ preprocessing steps are responsible for generating the input files required to run the CMAQ adjoint.
This includes:
* Generating the meteorology, initial and boundary conditions for CMAQ

This step is run after the meteorological data has been generated by the WRF model 
(see [setup-wrf](https://github.com/openmethane/setup-wrf)).
Some example WRF data for the `au-test` domain is available in the `tests/test-data/wrf` directory.

## download_cams_input

Download Methane chemistry data from CAMS on pressure levels.

## setup_for_cmaq

The `scripts/cmaq_preprocess/setup_for_cmaq.py` script generates the required configuration
and data to run CMAQ for a given domain and time.

Before running this script, 
the WRF model must be run to generate the meteorological data and the CAMS data must be downloaded
(`scripts/cmaq_preprocess/download_cams_input.py`) for the period of interest.
[CAMS](https://www.copernicus.eu/en/access-data/copernicus-services-catalogue/cams-global-reanalysis-eac4) 
is a global atmospheric reanalysis data set that can be used to provide boundary conditions for CMAQ.

The `setup_for_cmaq.py` script does the following:
* Checks if the required input files are available (WRF output files from the above section)
* Run MCIP to extract the meteorological data from the WRF output files and interpolate onto the CMAQ grid
* Prepares the initial and boundary conditions for CMAQ (using ICON and BCON respectively)
* Interpolate CAMS data to the CMAQ grid

After the `setup_for_cmaq.py` script has been run successfully,
there should be results in the `data/mcip` and `data/cmaq` directory.


## make_emis_template

Create emissions template files for CMAQ using the OpenMethane prior data

## make_template

The `make_template` script 
- copies a template emissions file into the input directory
- defines CMAQ filenames for first day of model run
- prepares CMAQ run directories
- redefines any `cmaq_config` variables dependent on template files
- generates sample files by running 1 day of CMAQ (forward & backward)
- makes force file with same attr as conc and all data zeroed
- creates template for conc, force & sense files
- cleans up files created by cmaq

## make_prior
Create a dataset containing the initial assumption about emissions
